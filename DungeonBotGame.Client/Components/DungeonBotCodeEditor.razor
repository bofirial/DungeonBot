@using System.Collections.Immutable
@using BlazorMonaco
@using BlazorMonaco.Bridge
@using DungeonBotGame.Client.BusinessLogic.Compilation
@using Microsoft.AspNetCore.Components
@using DungeonBotGame.Models.ViewModels

<MonacoEditor @ref="CSharpEditor" CssClass="@CssClass" Id="@Id" ConstructionOptions="EditorConstructionOptions"></MonacoEditor>

@code {
    public string Id { get; set; } = $"monaco-container-{Guid.NewGuid()}";

    [Parameter]
    public IImmutableList<ActionModuleFileViewModel> Files { get; set; } = ImmutableList.Create<ActionModuleFileViewModel>();

    [Parameter]
    public string CssClass { get; set; } = string.Empty;

    [Parameter]
    public bool ReadOnly { get; set; } = false;

    [Parameter]
    public DungeonBotViewModel? DungeonBot { get; set; }

    @inject ICodeCompletionService CodeCompletionService

    private MonacoEditor? CSharpEditor { get; set; }

    protected async override Task OnInitializedAsync()
    {
        if (DungeonBot != null)
        {
            await CodeCompletionService.InitializeCodeEditorAsync(DungeonBot);
        }

        await base.OnInitializedAsync();
    }

    public async Task<IImmutableList<ActionModuleFileViewModel>> GetValueAsync()
    {

        if (CSharpEditor == null)
        {
            return Files;
        }

        var code = await CSharpEditor.GetValue();
        var actionModuleFile = Files.First();

        return ImmutableList.Create(actionModuleFile with { Content = code });
    }

    public async Task SetValueAsync(IImmutableList<ActionModuleFileViewModel> files)
    {
        Files = files;

        if (CSharpEditor != null)
        {
            await CSharpEditor.SetValue(files[0].Content);
        }
    }

    private StandaloneEditorConstructionOptions EditorConstructionOptions(MonacoEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "csharp",
            Theme = "vs-dark",
            Value = Files[0].Content,
            ReadOnly = ReadOnly
        };
    }
    }
